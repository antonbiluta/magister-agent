stages:
  - build
  - release

variables:
  BINARY_NAME: agent
  GIT_STRATEGY: fetch

build:
  image: golang:1.23
  stage: build
  tags:
    - docker
  parallel:
    matrix:
      - GOOS: "linux"
        GOARCH: "amd64"
      - GOOS: "windows"
        GOARCH: "amd64"
  script:
    - export GOOS=$GOOS
    - export GOARCH=$GOARCH
    - mkdir -p build
    - echo "Building for $GOOS/$GOARCH"
    - CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH go build -ldflags "-s -w" -o build/${BINARY_NAME}_${GOOS}_${GOARCH} main.go
    - ls -la build/
  artifacts:
    paths:
      - build/
    expire_in: 1d
  only:
    - branches
    - tags

release:
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  stage: release
  tags:
    - docker
  only:
    - tags
  script:
    - |
      for file in build/*; do
        FILENAME=$(basename "$file")
        echo "Uploading $FILENAME to Package Registry..."

        curl --fail --header "JOB-TOKEN: $CI_JOB_TOKEN" \
          --upload-file "$file" \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/generic/$PACKAGE_NAME/$CI_COMMIT_TAG/$FILENAME"

        echo "  {\"name\": \"$FILENAME\", \"url\": \"$CI_PROJECT_URL/-/packages/generic/$PACKAGE_NAME/$CI_COMMIT_TAG/$FILENAME\"}" >> tmp-links/links.json
      done

      echo "[" > "$RELEASE_JSON"
      paste -sd, tmp-links/links.json >> "$RELEASE_JSON"
      echo "]" >> "$RELEASE_JSON"

      jq -n \
        --arg tag "$CI_COMMIT_TAG" \
        --arg name "$CI_COMMIT_TAG" \
        --arg desc "$(awk "/^## $CI_COMMIT_TAG/{flag=1;next}/^## /{flag=0}flag" CHANGELOG.md | sed 's/"/\\"/g')" \
        --slurpfile links "$RELEASE_JSON" \
        '{
          tag_name: $tag,
          name: $name,
          description: $desc,
          assets: {
            links: $links[0]
          }
        }' > full-release.json
      
    - cat full-release.json
    - release-cli create --json full-release.json